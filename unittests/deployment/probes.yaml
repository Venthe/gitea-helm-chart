suite: deployment template (probes)
release:
  name: gitea-unittests
  namespace: testing
templates:
  - templates/gitea/deployment.yaml
  - templates/gitea/config.yaml
tests:
  - it: renders default liveness probe
    template: templates/gitea/deployment.yaml
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0].livenessProbe
          content:
            failureThreshold: 10
            initialDelaySeconds: 200
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: http
            timeoutSeconds: 1
  - it: renders default readiness probe
    template: templates/gitea/deployment.yaml
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0].readinessProbe
          content:
            failureThreshold: 3
            initialDelaySeconds: 5
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: http
            timeoutSeconds: 1
  - it: does not render a default startup probe
    template: templates/gitea/deployment.yaml
    asserts:
      - notExists:
          path: spec.template.spec.containers[0].startupProbe
  - it: allows enabling a startup probe
    template: templates/gitea/deployment.yaml
    set:
      gitea.startupProbe.enabled: true
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0].startupProbe
          content:
            failureThreshold: 10
            initialDelaySeconds: 60
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: http
            timeoutSeconds: 1
